generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id               String             @id @default(cuid())
  name             String?
  email            String?           @unique
  emailVerified    DateTime?
  image            String?
  password         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  accounts         Account[]
  betaApplications BetaApplication[]
  properties       Property[]
  sessions         Session[]
  tenantApplications TenantApplication[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model BetaApplication {
  id              String   @id @default(cuid())
  name            String
  email           String
  location        String
  estimatedAssets String
  companyName     String
  role            String
  additionalInfo  String?
  userId          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  status          String   @default("pending")
  user            User?    @relation(fields: [userId], references: [id])
}

model Property {
  id           String   @id @default(cuid())
  name         String
  photo        String
  phone        String
  tenantName   String
  unit         String
  address      String
  hotline      String
  portalUrl    String
  propertyName String
  tenantPhone  String?
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leases       Lease[]
  context      PropertyContext?
  settings     PropertySettings?
  tenantApplications TenantApplication[]
}

model Lease {
  id              String   @id @default(cuid())
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  fileName        String
  originalName    String
  fileUrl         String
  fileSize        Int
  mimeType        String
  summary         String?  // AI-generated summary
  keyTerms        String?  // AI-extracted key terms
  startDate       DateTime?
  endDate         DateTime?
  monthlyRent     Float?
  securityDeposit Float?
  isActive        Boolean  @default(true)
  uploadedBy      String   // userId who uploaded
  uploadedAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PropertyContext {
  id                String   @id @default(cuid())
  propertyId        String   @unique
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Basic Property Details
  bedrooms          Int?
  bathrooms         Float?
  squareFootage     Int?
  propertyType      String?  // Single Family, Condo, Townhouse, etc.
  yearBuilt         Int?
  lotSize           String?
  
  // Architectural & Style
  architecturalStyle String?  // Modern, Traditional, Colonial, etc.
  exteriorFeatures   String?  // Pool, Deck, Garage, etc.
  interiorFeatures   String?  // Hardwood floors, granite counters, etc.
  
  // Location & Neighborhood
  neighborhood      String?
  walkScore         Int?
  transitScore      Int?
  bikeScore         Int?
  crimeRate         String?  // Low, Medium, High
  
  // Schools & Education
  elementarySchool  String?
  middleSchool      String?
  highSchool        String?
  schoolDistrict    String?
  schoolRatings     String?  // JSON string with school ratings
  
  // Transportation & Commute
  nearbyTransit     String?  // Bus stops, train stations
  majorHighways     String?  // Nearby highways
  commuteTimes      String?  // JSON string with commute times to major areas
  
  // Amenities & Services
  nearbyAmenities   String?  // Shopping, restaurants, parks
  healthcareFacilities String?
  entertainment     String?  // Theaters, sports venues, etc.
  
  // Market Information
  estimatedValue    Float?
  pricePerSqFt      Float?
  marketTrends      String?  // Rising, Stable, Declining
  comparableProperties String? // JSON string with comp data
  
  // AI-Generated Content
  propertyDescription String?  // AI-generated property description
  keySellingPoints   String?  // AI-identified key selling points
  potentialConcerns  String?  // AI-identified potential concerns
  targetDemographics String?  // AI-identified target tenant demographics
  
  // Metadata
  lastUpdated       DateTime @updatedAt
  createdAt         DateTime @default(now())
  aiModel           String?  // Which AI model was used
  confidenceScore   Float?   // AI confidence in the analysis
}

model PropertySettings {
  id                 String   @id @default(cuid())
  propertyId         String   @unique
  property           Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Screening Criteria
  minCreditScore     Int      @default(600)
  incomeMultiplier   Float    @default(3.0)  // Rent must be <= income / multiplier
  minIncomeMultiplier Float   @default(2.5)  // Yellow flag threshold
  
  // Business Hours for Scheduling
  businessHoursStart String   @default("09:00")  // Format: "HH:MM"
  businessHoursEnd   String   @default("18:00")  // Format: "HH:MM"
  excludeWeekends    Boolean  @default(false)
  
  // Parking Instructions
  parkingInstructions String?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model TenantApplication {
  id              String   @id @default(cuid())
  userId          String   // Property manager who owns this application
  propertyId      String?  // Link to Property model (optional, may not know property yet)
  property        Property? @relation(fields: [propertyId], references: [id])
  
  // Contact Info (from email)
  applicantName   String
  applicantEmail  String
  applicantPhone  String?
  
  // Email Metadata
  emailSubject    String?
  emailBody       String?  // Full email text for context
  receivedAt      DateTime @default(now())
  
  // Document Attachments (store file URLs like Lease model)
  driversLicenseUrl    String?
  driversLicenseText   String?  // OCR extracted text
  payStubUrls          String[] // Array of pay stub file URLs
  payStubTexts         String[] // OCR extracted text for each
  creditScoreUrl       String?
  creditScoreText      String?  // OCR extracted text
  
  // Extracted Data (from document processing)
  licenseName          String?
  licenseDOB           DateTime?
  licenseExpiration    DateTime?
  licenseNumber        String?
  
  employerName         String?
  monthlyIncome        Float?
  annualIncome         Float?
  payFrequency         String?  // "weekly", "bi-weekly", "monthly"
  
  creditScore          Int?
  creditScoreDate      DateTime?
  
  // Screening Status
  status               String   @default("pending") // "pending", "under_review", "approved", "rejected", "scheduled"
  screeningScore       String?  // "green", "yellow", "red"
  screeningNotes       String?
  
  // Background Check
  backgroundCheckResult Json?   // Background check results from screening service
  backgroundCheckCompletedAt DateTime?
  
  // Scheduling
  calendarEventId      String?  // Google Calendar event ID (from Hyperspell)
  scheduledDate        DateTime?
  scheduledTime        String?
  showingConfirmed     Boolean  @default(false)
  
  // Metadata
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([propertyId])
  @@index([status])
}
